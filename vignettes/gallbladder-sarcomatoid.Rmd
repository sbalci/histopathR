---
title: "Gallbladder Sarcomatoid"
output:
  pdf_document:
    fig_caption: yes
    highlight: kate
    number_sections: yes
    toc: yes
    latex_engine: lualatex
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 3
  word_document:
    toc: yes
    toc_depth: '3'
  html_notebook:
    code_folding: hide
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_float: yes
    fig_height: 6
---

---



```{r load library}
suppressMessages(library(tidyverse))
suppressMessages(library(foreign))
suppressMessages(library(tidylog))
suppressMessages(library(janitor))
suppressMessages(library(report))
suppressMessages(library(formatR))
suppressMessages(library(jmv))
suppressMessages(library(tangram))
suppressMessages(library(finalfit))
suppressMessages(library(summarytools))
suppressMessages(library(ggstatsplot))
suppressMessages(library(readxl))
suppressMessages(library(survival))
```



```{r setup global_options chunk settings}
knitr::opts_chunk$set(
	echo = TRUE,
	error = FALSE,
	# fig.height = 8,
	# fig.width = 12,
	message = FALSE,
	warning = FALSE,
	# cache = TRUE,
	comment = NA,
	tidy = TRUE
	# tidy.opts=list(width.cutoff=60),
	# results = "asis"
)
```


---

```{r read sarcomatoid vs others}
library(readxl)
GB_sarcomatoid_vs_others <- read_excel("GB-sarcomatoid-vs-others.xlsx", 
    col_types = c("text", "text", "numeric", 
        "text", "numeric", "text"), na = "N/A")
# View(GB_sarcomatoid_vs_others)
GB_sarcomatoid_vs_others <- GB_sarcomatoid_vs_others %>% 
    janitor::clean_names()
```


```{r poorly}
library(readxl)
SOLID_GB_CA_DATA_3_7_2012 <- read_excel("SOLID_GB_CA_DATA-3-7-2012.xls", 
    sheet = "poorly medullary-PELIN-DATA")
# View(SOLID_GB_CA_DATA_3_7_2012)
SOLID_GB_CA_DATA_3_7_2012 <- SOLID_GB_CA_DATA_3_7_2012 %>% 
    janitor::clean_names()
```

---

```{r clean columns of sarcomatoid data}
sarcomatoid <- GB_sarcomatoid_vs_others %>% 
    select(surgpathno = slide_number,
           histogroup = dx,
           age,
           gender = sex,
           time = survival_months,
           status
    )

sarcomatoid$surgpathno <- trimws(sarcomatoid$surgpathno)

sarcomatoid$surgpathno <- gsub(pattern = "[a-zA-Z]", replacement = "", x = sarcomatoid$surgpathno)

sarcomatoid$surgpathno <- gsub(pattern = "-", replacement = " ", x = sarcomatoid$surgpathno)

sarcomatoid$surgpathno <- substr(x = sarcomatoid$surgpathno, start = 1, stop = 8)

```


```{r recode sarcomatoid}
## Recoding sarcomatoid$gender
sarcomatoid$gender <- recode(sarcomatoid$gender,
               "F" = "Female",
               "M" = "Male",
               "m" = "Male",
               "f" = "Female")
sarcomatoid$gender <- factor(sarcomatoid$gender)

## Recoding sarcomatoid$status
sarcomatoid$status <- recode(sarcomatoid$status,
               "ALIVE" = "0",
               "DOD" = "1",
               "AED" = "0",
               "D0D" = "1",
               "DOC" = "1",
               "DOCC" = "1")
sarcomatoid$status <- as.numeric(sarcomatoid$status)


sarcomatoid$age <- as.numeric(as.character(sarcomatoid$age))

sarcomatoid$time <- as.numeric(as.character(sarcomatoid$time))

```


```{r get data from poorly}
poorly <- SOLID_GB_CA_DATA_3_7_2012 %>% 
    select(surgpathno = acc_number,
           histogroup2 = final_group_by_va)
```


```{r clean columns of poorly}
poorly$surgpathno <- gsub(pattern = "-", replacement = " ", x = poorly$surgpathno)
```


```{r join tables}
GallbladderSurvival <-  sarcomatoid %>% 
    full_join(poorly, by = "surgpathno")
```


**17 cases were added from excel `SOLID_GB_CA_DATA_3_7_2012.xlsx`**

**Undifferantiated (Solid) cases are MEDULLARY, SOLID NESTED, and HEPATOID.**



```{r see new added cases, eval=FALSE, include=FALSE}
GallbladderSurvival %>% 
    filter(is.na(histogroup))
```


<!-- ```{r save surgpathno for possible overlap} -->
<!-- GallbladderSurvival$surgpathno %>% -->
<!--     sort() %>%  -->
<!--     write("surgpathno.txt") -->
<!-- ``` -->

---

```{r}
unique(GallbladderSurvival$histogroup)
unique(GallbladderSurvival$histogroup2)

GallbladderSurvival <-
  GallbladderSurvival %>%
  mutate(
    Histomorphology = case_when(
      histogroup == "Sarcomatoid" ~ "Sarcomatoid",
      histogroup2 == "HEPATOID" ~ "Poorly",
      histogroup2 == "MEDULLARY" ~ "Poorly",
      histogroup2 == "SOLID NESTED" ~ "Poorly",
      histogroup == "Adenocarcinoma" & is.na(histogroup2) ~ "Adenocarcinoma"
    )
  )
```

```{r}
GallbladderSurvival %>% 
    janitor::tabyl(Histomorphology) %>% 
  adorn_pct_formatting(rounding = 'half up', digits = 1) %>%
  knitr::kable()
```



---

\pagebreak


# Survival Analysis


## Poorly vs Sarcomatoid



```{r form Poorly vs Sarcomatoid}

GallbladderSarcomatoidUndifferantiatedSurvival <- GallbladderSurvival %>% 
    filter(Histomorphology == "Poorly" | Histomorphology == "Sarcomatoid")


library(survival)
kmPS <- with(GallbladderSarcomatoidUndifferantiatedSurvival, Surv(time, status))
# head(kmPS,80)
# plot(kmPS)
```

---

```{r Kaplan-Meier Poorly vs Sarcomatoid}
explanatoryKMPS <-  c("Histomorphology")
dependentKMPS <-  "Surv(time, status)"
GallbladderSarcomatoidUndifferantiatedSurvival %>%
  finalfit::surv_plot(dependentKMPS, explanatoryKMPS, 
  xlab="Time (months)", pval=TRUE, legend = "none")
```



```{r Poorly vs Sarcomatoid}
km_fitPS <- survfit(Surv(time, status) ~ Histomorphology, data = GallbladderSarcomatoidUndifferantiatedSurvival)
km_fitPS
```


```{r 1-3-5-yr survival Poorly vs Sarcomatoid}
summary(km_fitPS, times = c(12,36,60))
```







## Adenocarcinoma vs Poorly vs Sarcomatoid



```{r}
library(survival)
km <- with(GallbladderSurvival, Surv(time, status))
# head(km,80)
# plot(km)
```

---

```{r Kaplan-Meier}
explanatoryKM <-  c("Histomorphology")
dependentKM <-  "Surv(time, status)"
GallbladderSurvival %>%
  finalfit::surv_plot(dependentKM, explanatoryKM, 
  xlab="Time (months)", pval=TRUE, legend = "none")
```



```{r}
km_fit <- survfit(Surv(time, status) ~ Histomorphology, data = GallbladderSurvival)
km_fit
```


```{r 1-3-5-yr survival}
summary(km_fit, times = c(12,36,60))
```











---

\pagebreak


# Save Final Data

saved data after analysis to `GallbladderSurvival.xlsx`.

```{r echo=FALSE}
saveRDS(GallbladderSurvival, "GallbladderSurvival.rds")

writexl::write_xlsx(GallbladderSurvival, "GallbladderSurvival.xlsx")

file.info("GallbladderSurvival.xlsx")$ctime

```

---

\pagebreak


# Libraries Used

```{r echo=FALSE}
citation()
```



---


```{r echo=FALSE, results='asis'}
report::cite_packages(session = sessionInfo())
```


---



```{r echo=FALSE}
sessionInfo()
```

---

\pagebreak



# Notes  

Completed on `r Sys.time()`.  

Serdar Balci, MD, Pathologist  
drserdarbalci@gmail.com  
https://rpubs.com/sbalci/CV   


---



